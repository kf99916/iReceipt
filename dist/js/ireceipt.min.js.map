{"version":3,"file":"ireceipt.min.js","sources":["../../src/js/tax-type.js","../../src/js/receipt-info.js","../../src/js/item.js","../../src/js/amount.js","../../src/js/common/utils.js","../../src/js/encode-type.js","../../src/js/aes.js","../../src/js/receipt.js"],"sourcesContent":["export default {\n    TAX: 1,\n    ZERO_TAX: 2,\n    FREE_TAX: 3,\n    SPECIAL_TAX: 4,\n    COMPOUND_TAX: 9\n};\n","import { format } from 'date-fns/esm';\n\nclass ReceiptInfo {\n    constructor(\n        number,\n        date,\n        seller,\n        buyer,\n        type = '07',\n        carrier,\n        donationID,\n        orderno\n    ) {\n        this.number = number;\n        this.date = date;\n        this.seller = seller;\n        this.buyer = buyer;\n        this.type = type;\n        this.carrier = carrier;\n        this.donationID = donationID;\n        this.orderno = orderno;\n        this.randomNumber = Math.floor(1000 + Math.random() * 9000);\n    }\n\n    toXMLObject() {\n        let xmlObject = {\n            InvoiceNumber: this.number,\n            InvoiceDate: format(this.date, 'YYYYMMDD'),\n            InvoiceTime: format(this.date, 'hh:mm:ss'),\n            Seller: {\n                Identifier: this.seller.id,\n                Name: this.seller.name\n            },\n            Buyer: {\n                Identifier: this.buyer.id || '0000000000',\n                Name: this.buyer.name\n            },\n            InvoiceType: this.type,\n            DonateMark: 0,\n            PrintMark: this.carrier ? 'N' : 'Y',\n            RandomNumber: this.randomNumber\n        };\n\n        if (this.donationID) {\n            xmlObject.DonateMark = 1;\n            xmlObject.NPOBAN = this.donationID;\n        }\n\n        if (this.carrier) {\n            xmlObject.CarrierType = this.carrier.type;\n            xmlObject.CarrierId1 = this.carrier.id;\n            xmlObject.CarrierId2 = this.carrier.id;\n        }\n\n        return xmlObject;\n    }\n}\n\nexport default ReceiptInfo;\n","import TaxType from './tax-type';\n\nclass Item {\n    constructor(\n        description,\n        unitPrice,\n        sequenceNumber,\n        quantity = 1,\n        taxType = TaxType.TAX\n    ) {\n        this.description = description;\n        this.unitPrice = parseInt(unitPrice);\n        this.sequenceNumber = sequenceNumber;\n        this.quantity = parseInt(quantity);\n        this.taxType = taxType;\n    }\n\n    toXMLObject() {\n        return {\n            ProductItem: {\n                Description: this.description,\n                Quantity: this.quantity,\n                UnitPrice: this.unitPrice,\n                Amount: this.amount,\n                SequenceNumber: this.sequenceNumber\n            }\n        };\n    }\n\n    get amount() {\n        return this.unitPrice * this.quantity;\n    }\n}\n\nexport default Item;\n","import TaxType from './tax-type';\n\nclass Amount {\n    constructor(taxItems, freeTaxItems, zeroTaxItems) {\n        const taxRate = 0.05;\n        this.salesAmount = Math.round(\n            taxItems.reduce(\n                (amount, item) => (amount + item.amount) / (1 + taxRate),\n                0\n            )\n        );\n        this.freeTaxSalesAmount = Math.round(\n            freeTaxItems.reduce((amount, item) => amount + item.amount, 0)\n        );\n        this.zeroTaxSalesAmount = Math.round(\n            zeroTaxItems.reduce((amount, item) => amount + item.amount, 0)\n        );\n\n        const hasTax = this.salesAmount !== 0,\n            hasFreeTax = this.freeTaxSalesAmount !== 0,\n            hasZeroTax = this.zeroTaxSalesAmount !== 0;\n\n        this.taxType = TaxType.SPECIAL_TAX;\n        if (\n            (hasTax && hasFreeTax) ||\n            (hasTax && hasZeroTax) ||\n            (hasFreeTax && hasZeroTax)\n        ) {\n            this.taxType = TaxType.COMPOUND_TAX;\n        } else if (hasTax) {\n            this.taxType = TaxType.TAX;\n        } else if (hasFreeTax) {\n            this.taxType = TaxType.FREE_TAX;\n        } else if (hasZeroTax) {\n            this.taxType = TaxType.ZERO_TAX;\n        }\n        this.taxRate =\n            this.taxType === TaxType.FREE_TAX ||\n            this.taxType === TaxType.ZERO_TAX\n                ? 0\n                : taxRate;\n        this.taxAmount = Math.round(this.salesAmount * this.taxRate);\n        this.totalAmount =\n            this.salesAmount +\n            this.freeTaxSalesAmount +\n            this.zeroTaxSalesAmount +\n            this.taxAmount;\n    }\n\n    toXMLObject() {\n        return {\n            SalesAmount: this.salesAmount,\n            FreeTaxSalesAmount: this.freeTaxSalesAmount,\n            ZeroTaxSalesAmount: this.zeroTaxSalesAmount,\n            TaxType: this.taxType,\n            TaxRate: this.taxRate,\n            TaxAmount: this.taxAmount,\n            TotalAmount: this.totalAmount\n        };\n    }\n}\n\nexport default Amount;\n","export default {\n    padZero: function(number, size) {\n        return ('000000000' + number).substr(-size);\n    },\n    repeat: function(string, times) {\n        let repeatedString = '';\n        while (times > 0) {\n            repeatedString += string;\n            times--;\n        }\n        return repeatedString;\n    }\n};\n","export default {\n    BIG5: 0,\n    UTF8: 1,\n    BASE64: 3\n};\n","import aesjs from 'aes-js';\n\nexport default {\n    encrypt: function(AESKey, plainText) {\n        if (!AESKey) {\n            throw new TypeError('AES Key is not found!');\n        }\n        const textBytes = aesjs.utils.utf8.toBytes(plainText),\n            aesCtr = new aesjs.ModeOfOperation.ctr(\n                AESKey,\n                new aesjs.Counter(5)\n            );\n\n        return aesCtr.encrypt(textBytes);\n    },\n    decrypt: function(AESKey, encryptedBytes) {\n        if (!AESKey) {\n            throw new TypeError('AES Key is not found');\n        }\n        const aesCtr = new aesjs.ModeOfOperation.ctr(\n                AESKey,\n                new aesjs.Counter(5)\n            ),\n            decryptedBytes = aesCtr.decrypt(encryptedBytes);\n\n        return aesjs.utils.utf8.fromBytes(decryptedBytes);\n    }\n};\n","import xml2js from 'xml2js';\nimport TaxType from './tax-type';\nimport ReceiptInfo from './receipt-info';\nimport Item from './item';\nimport Amount from './amount';\nimport utils from './common/utils';\nimport EncodeType from './encode-type';\nimport aes from './aes';\nimport JsBarcode from 'jsbarcode';\nimport QRCode from 'qrcode';\nimport { format } from 'date-fns/esm';\nimport template from '../template/ireceipt.html';\n\nconst defaultInvoiceAttr = {\n        xmlns: 'urn:GEINV:eInvoiceMessage:C0401:3.1',\n        'xmlns:xsi': 'http://www.w3.org/2001/XMLSchema-instance',\n        'xsi:schemaLocation': 'urn:GEINV:eInvoiceMessage:C0401:3.1 C0401.xsd'\n    },\n    renderQRcode = function(text) {\n        return new Promise((resolve, reject) => {\n            const opts = {\n                errorCorrectionLevel: 'L',\n                version: 6\n            };\n            QRCode.toString(text, opts, (err, string) => {\n                if (err) {\n                    reject(error);\n                }\n                resolve(string);\n            });\n        });\n    };\n\nclass Receipt {\n    constructor(info, items) {\n        if (!(info instanceof ReceiptInfo)) {\n            throw new TypeError('Info is not ReceiptInfo class!');\n        }\n        const invalidItems = items.filter(item => {\n            return !(item instanceof Item);\n        });\n        if (invalidItems.length > 0) {\n            throw new TypeError('Some items are not Item class!');\n        }\n\n        this.info = info;\n        this.items = items;\n        this.amount = new Amount(\n            this.taxItems,\n            this.freeTaxItems,\n            this.zeroTaxItems\n        );\n    }\n\n    // Static Methods\n    // The format of the list of winners:\n    // 53925591  10510LC60123189...\n    // 53925591  10510LC60122037...\n    // The range of receipt number is the 15th position and 10 characters\n    static parseWinnersList(winnersList) {\n        return winnersList.split(/\\n|\\r\\n?/).map(winner => {\n            return winner.substr(15, 10);\n        });\n    }\n\n    // Getters\n    get taxItems() {\n        return this.items.filter(item => {\n            return item.taxType === TaxType.TAX;\n        });\n    }\n\n    get freeTaxItems() {\n        return this.items.filter(item => {\n            return item.taxType === TaxType.FREE_TAX;\n        });\n    }\n\n    get zeroTaxItems() {\n        return this.items.filter(item => {\n            return item.taxType === TaxType.ZERO_TAX;\n        });\n    }\n\n    get chineseYear() {\n        return this.info.date.getFullYear() - 1911;\n    }\n\n    get winningMonths() {\n        let month = this.info.date.getMonth() + 1;\n        return month % 2 === 0 ? [month - 1, month] : [month, month + 1];\n    }\n\n    get totalQuantity() {\n        return this.items.reduce((sum, item) => {\n            return sum + item.quantity;\n        }, 0);\n    }\n\n    // Methods\n    // Reference: https://www.einvoice.nat.gov.tw/home/DownLoad?fileName=1447235507091_0.zip\n    toXML() {\n        let receiptObject = {\n            $: defaultInvoiceAttr,\n            Main: this.info.toXMLObject(),\n            Details: this.items.map(item => {\n                return item.toXMLObject();\n            }),\n            Amounts: this.amount.toXMLObject()\n        };\n\n        const builder = new xml2js.Builder({\n            rootName: 'Invoice'\n        });\n        return builder.buildObject(receiptObject);\n    }\n\n    isWinning(winningNumbers) {\n        return winningNumbers.indexOf(this.info.number) !== -1;\n    }\n\n    // Reference: https://www.einvoice.nat.gov.tw/home/DownLoad?fileName=1479449792874_0.6(20161115).pdf\n    generateBarCodeString() {\n        return (\n            this.chineseYear +\n            utils.padZero(this.winningMonths[1], 2) +\n            this.info.number +\n            this.info.randomNumber\n        );\n    }\n\n    // Reference: https://www.einvoice.nat.gov.tw/home/DownLoad?fileName=1479449792874_0.6(20161115).pdf\n    generateRightQRCodeString() {\n        let qrcode = this.items.map((item, index) => {\n            let combineString = [];\n            combineString.push(index === 0 ? '**' : ':');\n            combineString.push(item.description.replace(':', '-'));\n            combineString.push(':' + item.quantity);\n            combineString.push(':' + item.unitPrice);\n            return combineString.join('');\n        });\n\n        return qrcode.join('');\n    }\n\n    generateLeftQRCodeString(\n        AESKey,\n        info = utils.repeat('*', 10),\n        encodeType = EncodeType.UTF8\n    ) {\n        if (!AESKey) {\n            throw new TypeError('AES Key is not found');\n        }\n\n        let qrcode = [],\n            dateString =\n                this.chineseYear +\n                utils.padZero(this.info.date.getMonth() + 1, 2) +\n                utils.padZero(this.info.date.getDate(), 2),\n            salesAmountHex16 = utils.padZero(\n                this.amount.salesAmount.toString(16).toUpperCase(),\n                8\n            ),\n            totalAmountHex16 = utils.padZero(\n                this.amount.totalAmount.toString(16).toUpperCase(),\n                8\n            ),\n            plainText = this.info.number + this.info.randomNumber,\n            padding = 16 - plainText.length % 16;\n\n        plainText += utils.repeat(padding, padding);\n\n        const encryptText = Buffer.from(\n            aes.encrypt(AESKey, plainText)\n        ).toString('base64');\n\n        qrcode.push(this.info.number);\n        qrcode.push(dateString);\n        qrcode.push(this.info.randomNumber);\n        qrcode.push(salesAmountHex16);\n        qrcode.push(totalAmountHex16);\n        qrcode.push(this.info.buyer.id || utils.repeat('0', 8));\n        qrcode.push(this.info.seller.id);\n        qrcode.push(encryptText);\n        qrcode.push(':' + info);\n        qrcode.push(':' + this.items.length);\n        qrcode.push(':' + this.totalQuantity);\n        qrcode.push(':' + encodeType);\n\n        return qrcode.join('');\n    }\n\n    render(AESKey) {\n        if (!AESKey) {\n            throw new TypeError('AES Key is not found');\n        }\n\n        const promises = [\n                this.renderBarCode(),\n                this.renderLeftQRCode(AESKey),\n                this.renderRightQRCode()\n            ],\n            intlNumberFormat = new Intl.NumberFormat();\n\n        return Promise.all(promises).then(\n            ([barCode, leftQRCode, rightQRCode]) => {\n                const buyerIdHtmlString = this.info.buyer.id\n                    ? `<div class=\"buyer-identifier\">\n                        買方${this.info.buyer.id}\n                      </div>`\n                    : '';\n\n                return `${template}\n                    <div class=\"receipt\">\n                        <div class=\"einvoice-name\">\n                            ${this.info.seller.name}\n                        </div>\n                        <div class=\"receipt-title\">電子發票證明聯</div>\n                        <div class=\"receipt-year-month\">\n                            ${this.chineseYear}年\n                            ${this.winningMonths[0]}-${this.winningMonths[1]}月 \n                        </div>\n                        <div class=\"receipt-invoice-number\">\n                            ${this.info.number}\n                        </div>\n                        <div class=\"receipt-issue-time\">\n                            ${format(this.info.date, 'YYYY-MM-DD hh:mm:ss')}\n                        </div>\n                        <div class=\"receipt-random-number\">\n                            隨機碼 ${this.info.randomNumber}\n                        </div>\n                        <div class=\"receipt-amount\">\n                            總計 ${intlNumberFormat.format(\n                                this.amount.totalAmount\n                            )}\n                        </div>\n                        <div class=\"einvoice-identifier\">\n                            賣方${this.info.seller.id}\n                        </div>\n                        ${buyerIdHtmlString}\n                        <div class=\"einvoice-barcode\">${barCode}</div>\n                        <div class=\"einvoice-qrcode-left\">${leftQRCode}</div>\n                        <div class=\"einvoice-qrcode-right\">${rightQRCode}</div>\n                        <div class=\"einvoice-remark\">退貨憑電子發票證明聯正本辦理</div>\n                    </div>`;\n            }\n        );\n    }\n\n    renderBarCode() {\n        const svgObject = document.createElementNS(\n                'http://www.w3.org/2000/svg',\n                'svg'\n            ),\n            xmlSerializer = new XMLSerializer();\n\n        JsBarcode(svgObject, this.generateBarCodeString(), {\n            format: 'CODE39',\n            displayValue: false,\n            width: 0.6,\n            height: 25\n        });\n\n        return Promise.resolve(xmlSerializer.serializeToString(svgObject));\n    }\n\n    renderRightQRCode() {\n        return renderQRcode(this.generateRightQRCodeString());\n    }\n\n    renderLeftQRCode(AESKey) {\n        if (!AESKey) {\n            throw new TypeError('AES Key is not found');\n        }\n        return renderQRcode(this.generateLeftQRCodeString(AESKey));\n    }\n\n    get taxItems() {\n        return this.items.filter(item => {\n            return item.taxType === TaxType.TAX;\n        });\n    }\n\n    get freeTaxItems() {\n        return this.items.filter(item => {\n            return item.taxType === TaxType.FREE_TAX;\n        });\n    }\n\n    get zeroTaxItems() {\n        return this.items.filter(item => {\n            return item.taxType === TaxType.ZERO_TAX;\n        });\n    }\n\n    get chineseYear() {\n        return this.info.date.getFullYear() - 1911;\n    }\n\n    get winningMonths() {\n        let month = this.info.date.getMonth() + 1;\n        return month % 2 === 0 ? [month - 1, month] : [month, month + 1];\n    }\n\n    get totalQuantity() {\n        return this.items.reduce((sum, item) => {\n            return sum + item.quantity;\n        }, 0);\n    }\n}\n\nexport default {\n    Receipt: Receipt,\n    ReceiptInfo: ReceiptInfo,\n    Item: Item,\n    Amount: Amount,\n    TaxType: TaxType,\n    EncodeType: EncodeType\n};\n"],"names":["TAX","ZERO_TAX","FREE_TAX","SPECIAL_TAX","COMPOUND_TAX","constructor","number","date","seller","buyer","type","carrier","donationID","orderno","randomNumber","Math","floor","random","toXMLObject","InvoiceNumber","InvoiceDate","format","InvoiceTime","Seller","Identifier","id","Name","name","Buyer","InvoiceType","DonateMark","PrintMark","RandomNumber","NPOBAN","CarrierType","CarrierId1","CarrierId2","description","unitPrice","parseInt","sequenceNumber","quantity","taxType","ProductItem","Description","Quantity","UnitPrice","Amount","amount","SequenceNumber","round","salesAmount","reduce","freeTaxSalesAmount","zeroTaxSalesAmount","taxRate","taxAmount","totalAmount","SalesAmount","FreeTaxSalesAmount","ZeroTaxSalesAmount","TaxType","TaxRate","TaxAmount","TotalAmount","padZero","substr","repeat","BIG5","UTF8","BASE64","encrypt","TypeError","utils","utf8","toBytes","ModeOfOperation","ctr","Counter","decrypt","fromBytes","xmlns","Promise","toString","errorCorrectionLevel","version","error","filter","length","info","items","taxItems","freeTaxItems","zeroTaxItems","parseWinnersList","split","map","chineseYear","getFullYear","winningMonths","getMonth","totalQuantity","toXML","$","Main","Details","Amounts","Builder","rootName","buildObject","isWinning","indexOf","generateBarCodeString","generateRightQRCodeString","replace","join","generateLeftQRCodeString","getDate","toUpperCase","Buffer","from","push","render","renderBarCode","renderLeftQRCode","renderRightQRCode","Intl","NumberFormat","all","then","document","createElementNS","XMLSerializer","displayValue","width","height","resolve","serializeToString","Receipt","ReceiptInfo","Item","EncodeType"],"mappings":"mkBAAA,MAAe,CACXA,IAAK,CADM,CAEXC,SAAU,CAFC,CAGXC,SAAU,CAHC,CAIXC,YAAa,CAJF,CAKXC,aAAc,CALH,CAAf,CCEA,OAAkB,CACdC,oBAKI,EAAO,IALX,OASE,CACE,KAAKC,MAAL,EADF,CAEE,KAAKC,IAAL,EAFF,CAGE,KAAKC,MAAL,EAHF,CAIE,KAAKC,KAAL,EAJF,CAKE,KAAKC,IAAL,EALF,CAME,KAAKC,OAAL,EANF,CAOE,KAAKC,UAAL,EAPF,CAQE,KAAKC,OAAL,EARF,CASE,KAAKC,YAAL,CAAoBC,KAAKC,KAAL,CAAW,IAAO,SAAKC,MAAL,EAAlB,CACvB,CAEDC,aAAc,CACV,GAAI,GAAY,CACZC,cAAe,KAAKb,MADR,CAEZc,YAAaC,QAAAA,CAAO,KAAKd,IAAZc,CAAkB,UAAlBA,CAFD,CAGZC,YAAaD,QAAAA,CAAO,KAAKd,IAAZc,CAAkB,UAAlBA,CAHD,CAIZE,OAAQ,CACJC,WAAY,KAAKhB,MAAL,CAAYiB,EADpB,CAEJC,KAAM,KAAKlB,MAAL,CAAYmB,IAFd,CAJI,CAQZC,MAAO,CACHJ,WAAY,KAAKf,KAAL,CAAWgB,EAAX,EAAiB,YAD1B,CAEHC,KAAM,KAAKjB,KAAL,CAAWkB,IAFd,CARK,CAYZE,YAAa,KAAKnB,IAZN,CAaZoB,WAAY,CAbA,CAcZC,UAAW,KAAKpB,OAAL,CAAe,GAAf,CAAqB,GAdpB,CAeZqB,aAAc,KAAKlB,YAfP,CAAhB,CA6BA,MAXI,MAAKF,UAWT,GAVI,EAAUkB,UAAV,CAAuB,CAU3B,CATI,EAAUG,MAAV,CAAmB,KAAKrB,UAS5B,EANI,KAAKD,OAMT,GALI,EAAUuB,WAAV,CAAwB,KAAKvB,OAAL,CAAaD,IAKzC,CAJI,EAAUyB,UAAV,CAAuB,KAAKxB,OAAL,CAAac,EAIxC,CAHI,EAAUW,UAAV,CAAuB,KAAKzB,OAAL,CAAac,EAGxC,GACH,CArDa,CCAlB,OAAW,CACPpB,kBAII,EAAW,CAJf,CAKI,EAAU,EAAQL,GALtB,CAME,CACE,KAAKqC,WAAL,EADF,CAEE,KAAKC,SAAL,CAAiBC,WAFnB,CAGE,KAAKC,cAAL,EAHF,CAIE,KAAKC,QAAL,CAAgBF,WAJlB,CAKE,KAAKG,OAAL,EACH,CAEDxB,aAAc,CACV,MAAO,CACHyB,YAAa,CACTC,YAAa,KAAKP,WADT,CAETQ,SAAU,KAAKJ,QAFN,CAGTK,UAAW,KAAKR,SAHP,CAITS,OAAQ,KAAKC,MAJJ,CAKTC,eAAgB,KAAKT,cALZ,CADV,CASV,CAED,GAAIQ,OAAJ,EAAa,CACT,MAAO,MAAKV,SAAL,CAAiB,KAAKG,QAChC,CA7BM,CCAX,OAAa,CACTpC,kBAAkD,OAE3BU,KAAKmC,KAFsB,CAC9C,KAAM,GAAU,IAAhB,CACA,KAAKC,WAAL,CAAmB,EACf,EAASC,MAAT,CACI,OAAkB,CAAC,EAAS,EAAKJ,MAAf,GAA0B,GAA1B,CADtB,CAEI,CAFJ,CADe,CAF2B,CAQ9C,KAAKK,kBAAL,CAA0B,EACtB,EAAaD,MAAb,CAAoB,OAAkB,EAAS,EAAKJ,MAApD,CAA4D,CAA5D,CADsB,CARoB,CAW9C,KAAKM,kBAAL,CAA0B,EACtB,EAAaF,MAAb,CAAoB,OAAkB,EAAS,EAAKJ,MAApD,CAA4D,CAA5D,CADsB,CAXoB,CAe9C,KAAM,GAA8B,CAArB,QAAKG,WAApB,CACI,EAAyC,CAA5B,QAAKE,kBADtB,CAEI,EAAyC,CAA5B,QAAKC,kBAFtB,CAIA,KAAKZ,OAAL,CAAe,EAAQvC,WAnBuB,CAqBzC,IAAD,EACC,IADD,EAEC,IAvByC,CAyB1C,KAAKuC,OAAL,CAAe,EAAQtC,YAzBmB,GA2B1C,KAAKsC,OAAL,CAAe,EAAQ1C,GA3BmB,GA6B1C,KAAK0C,OAAL,CAAe,EAAQxC,QA7BmB,KA+B1C,KAAKwC,OAAL,CAAe,EAAQzC,QA/BmB,EAiC9C,KAAKsD,OAAL,CACI,KAAKb,OAAL,GAAiB,EAAQxC,QAAzB,EACA,KAAKwC,OAAL,GAAiB,EAAQzC,QADzB,CAEM,CAFN,EAlC0C,CAsC9C,KAAKuD,SAAL,CAAiB,EAAW,KAAKL,WAAL,CAAmB,KAAKI,OAAnC,CAtC6B,CAuC9C,KAAKE,WAAL,CACI,KAAKN,WAAL,CACA,KAAKE,kBADL,CAEA,KAAKC,kBAFL,CAGA,KAAKE,SACZ,CAEDtC,aAAc,CACV,MAAO,CACHwC,YAAa,KAAKP,WADf,CAEHQ,mBAAoB,KAAKN,kBAFtB,CAGHO,mBAAoB,KAAKN,kBAHtB,CAIHO,QAAS,KAAKnB,OAJX,CAKHoB,QAAS,KAAKP,OALX,CAMHQ,UAAW,KAAKP,SANb,CAOHQ,YAAa,KAAKP,WAPf,CASV,CAzDQ,CCFb,MAAe,CACXQ,QAAS,aAAuB,CAC5B,MAAO,CAAC,aAAD,EAAuBC,MAAvB,CAA8B,EAA9B,CACV,CAHU,CAIXC,OAAQ,aAAwB,CAC5B,GAAI,GAAiB,EAArB,CAD4B,KAEb,CAAR,EAFqB,EAGxB,IAHwB,CAIxB,GAJwB,CAM5B,QACH,CAXU,CAAf,GCAe,CACXC,KAAM,CADK,CAEXC,KAAM,CAFK,CAGXC,OAAQ,CAHG,CDAf,GEEe,CACXC,QAAS,aAA4B,CACjC,GAAI,EAAJ,CACI,KAAM,IAAIC,UAAJ,CAAc,uBAAd,CAAN,CAEJ,KAAM,GAAY,EAAMC,KAAN,CAAYC,IAAZ,CAAiBC,OAAjB,GAAlB,CACI,EAAS,GAAI,GAAMC,eAAN,CAAsBC,GAA1B,GAEL,GAAI,GAAMC,OAAV,CAAkB,CAAlB,CAFK,CADb,CAMA,MAAO,GAAOP,OAAP,GACV,CAZU,CAaXQ,QAAS,aAAiC,CACtC,GAAI,EAAJ,CACI,KAAM,IAAIP,UAAJ,CAAc,sBAAd,CAAN,CAEJ,KAAM,GAAS,GAAI,GAAMI,eAAN,CAAsBC,GAA1B,GAEP,GAAI,GAAMC,OAAV,CAAkB,CAAlB,CAFO,CAAf,CAII,EAAiB,EAAOC,OAAP,GAJrB,CAMA,MAAO,GAAMN,KAAN,CAAYC,IAAZ,CAAiBM,SAAjB,GACV,CAxBU,CFFf,UGcQC,MAAO,sCACP,YAAa,4CACb,qBAAsB,iDAE1B,EAAe,WAAe,CAC1B,MAAO,IAAIC,QAAJ,CAAY,OAAqB,CAKpC,EAAOC,QAAP,GAJa,CACTC,qBAAsB,GADb,CAETC,QAAS,CAFA,CAIb,CAA4B,OAAiB,IAErC,EAAOC,KAAP,CAFqC,CAIzC,IACH,CALD,CAMH,CAXM,CAYV,EAEL,OAAc,CACVjF,gBAAyB,CACrB,GAAI,EAAE,cAAF,CAAJ,CACI,KAAM,IAAImE,UAAJ,CAAc,gCAAd,CAAN,CAEJ,KAAM,GAAe,EAAMe,MAAN,CAAa,KACvB,EAAE,cAAF,CADU,CAArB,CAGA,GAA0B,CAAtB,GAAaC,MAAjB,CACI,KAAM,IAAIhB,UAAJ,CAAc,gCAAd,CAAN,CAGJ,KAAKiB,IAAL,EAXqB,CAYrB,KAAKC,KAAL,EAZqB,CAarB,KAAK1C,MAAL,CAAc,MACV,KAAK2C,QADK,CAEV,KAAKC,YAFK,CAGV,KAAKC,YAHK,CAKjB;;;;;AAOD,MAAOC,iBAAP,GAAqC,CACjC,MAAO,GAAYC,KAAZ,CAAkB,UAAlB,EAA8BC,GAA9B,CAAkC,KAC9B,EAAO9B,MAAP,CAAc,EAAd,CAAkB,EAAlB,CADJ,CAGV;AAGD,GAAIyB,SAAJ,EAAe,CACX,MAAO,MAAKD,KAAL,CAAWH,MAAX,CAAkB,KACd,EAAK7C,OAAL,GAAiB,EAAQ1C,GAD7B,CAGV,CAED,GAAI4F,aAAJ,EAAmB,CACf,MAAO,MAAKF,KAAL,CAAWH,MAAX,CAAkB,KACd,EAAK7C,OAAL,GAAiB,EAAQxC,QAD7B,CAGV,CAED,GAAI2F,aAAJ,EAAmB,CACf,MAAO,MAAKH,KAAL,CAAWH,MAAX,CAAkB,KACd,EAAK7C,OAAL,GAAiB,EAAQzC,QAD7B,CAGV,CAED,GAAIgG,YAAJ,EAAkB,CACd,MAAO,MAAKR,IAAL,CAAUlF,IAAV,CAAe2F,WAAf,GAA+B,IACzC,CAED,GAAIC,cAAJ,EAAoB,CAChB,GAAI,GAAQ,KAAKV,IAAL,CAAUlF,IAAV,CAAe6F,QAAf,GAA4B,CAAxC,CACA,MAAqB,EAAd,IAAQ,CAAR,CAAkB,CAAC,EAAQ,CAAT,GAAlB,CAAuC,GAAQ,EAAQ,CAAhB,CACjD,CAED,GAAIC,cAAJ,EAAoB,CAChB,MAAO,MAAKX,KAAL,CAAWtC,MAAX,CAAkB,OACd,EAAM,EAAKX,QADf,CAEJ,CAFI,CAGV;;AAID6D,OAAQ,CACJ,GAAI,GAAgB,CAChBC,GADgB,CAEhBC,KAAM,KAAKf,IAAL,CAAUvE,WAAV,EAFU,CAGhBuF,QAAS,KAAKf,KAAL,CAAWM,GAAX,CAAe,KACb,EAAK9E,WAAL,EADF,CAHO,CAMhBwF,QAAS,KAAK1D,MAAL,CAAY9B,WAAZ,EANO,CAApB,CASA,KAAM,GAAU,GAAI,GAAOyF,OAAX,CAAmB,CAC/BC,SAAU,SADqB,CAAnB,CAAhB,CAGA,MAAO,GAAQC,WAAR,GACV,CAEDC,YAA0B,CACtB,MAAoD,CAAC,CAA9C,KAAeC,OAAf,CAAuB,KAAKtB,IAAL,CAAUnF,MAAjC,CACV;AAGD0G,uBAAwB,CACpB,MACI,MAAKf,WAAL,CACA,EAAMhC,OAAN,CAAc,KAAKkC,aAAL,CAAmB,CAAnB,CAAd,CAAqC,CAArC,CADA,CAEA,KAAKV,IAAL,CAAUnF,MAFV,CAGA,KAAKmF,IAAL,CAAU3E,YAEjB;AAGDmG,2BAA4B,CACxB,GAAI,GAAS,KAAKvB,KAAL,CAAWM,GAAX,CAAe,OAAiB,CACzC,GAAI,GAAgB,CACS,CAAV,KAAc,IAAd,CAAqB,GADpB,CAED,EAAK3D,WAAL,CAAiB6E,OAAjB,CAAyB,GAAzB,CAA8B,GAA9B,CAFC,CAGD,IAAM,EAAKzE,QAHV,CAID,IAAM,EAAKH,SAJV,CAApB,CAKA,MAAO,GAAc6E,IAAd,CAAmB,EAAnB,CACV,CAPY,CAAb,CASA,MAAO,GAAOA,IAAP,CAAY,EAAZ,CACV,CAEDC,2BAEI,EAAO,EAAMjD,MAAN,CAAa,GAAb,CAAkB,EAAlB,CAFX,CAGI,EAAa,EAAWE,IAH5B,CAIE,CACE,GAAI,EAAJ,CACI,KAAM,IAAIG,UAAJ,CAAc,sBAAd,CAAN,CAGJ,GAAI,KAAJ,CACI,EACI,KAAKyB,WAAL,CACA,EAAMhC,OAAN,CAAc,KAAKwB,IAAL,CAAUlF,IAAV,CAAe6F,QAAf,GAA4B,CAA1C,CAA6C,CAA7C,CADA,CAEA,EAAMnC,OAAN,CAAc,KAAKwB,IAAL,CAAUlF,IAAV,CAAe8G,OAAf,EAAd,CAAwC,CAAxC,CAJR,CAKI,EAAmB,EAAMpD,OAAN,CACf,KAAKjB,MAAL,CAAYG,WAAZ,CAAwBgC,QAAxB,CAAiC,EAAjC,EAAqCmC,WAArC,EADe,CAEf,CAFe,CALvB,CASI,EAAmB,EAAMrD,OAAN,CACf,KAAKjB,MAAL,CAAYS,WAAZ,CAAwB0B,QAAxB,CAAiC,EAAjC,EAAqCmC,WAArC,EADe,CAEf,CAFe,CATvB,CAaI,EAAY,KAAK7B,IAAL,CAAUnF,MAAV,CAAmB,KAAKmF,IAAL,CAAU3E,YAb7C,CAcI,EAAU,GAAK,EAAU0E,MAAV,CAAmB,EAdtC,CAgBA,GAAa,EAAMrB,MAAN,KArBf,CAuBE,KAAM,GAAcoD,OAAOC,IAAP,CAChB,EAAIjD,OAAJ,KADgB,EAElBY,QAFkB,CAET,QAFS,CAApB,CAiBA,MAbA,GAAOsC,IAAP,CAAY,KAAKhC,IAAL,CAAUnF,MAAtB,CAaA,CAZA,EAAOmH,IAAP,GAYA,CAXA,EAAOA,IAAP,CAAY,KAAKhC,IAAL,CAAU3E,YAAtB,CAWA,CAVA,EAAO2G,IAAP,GAUA,CATA,EAAOA,IAAP,GASA,CARA,EAAOA,IAAP,CAAY,KAAKhC,IAAL,CAAUhF,KAAV,CAAgBgB,EAAhB,EAAsB,EAAM0C,MAAN,CAAa,GAAb,CAAkB,CAAlB,CAAlC,CAQA,CAPA,EAAOsD,IAAP,CAAY,KAAKhC,IAAL,CAAUjF,MAAV,CAAiBiB,EAA7B,CAOA,CANA,EAAOgG,IAAP,GAMA,CALA,EAAOA,IAAP,CAAY,KAAZ,CAKA,CAJA,EAAOA,IAAP,CAAY,IAAM,KAAK/B,KAAL,CAAWF,MAA7B,CAIA,CAHA,EAAOiC,IAAP,CAAY,IAAM,KAAKpB,aAAvB,CAGA,CAFA,EAAOoB,IAAP,CAAY,KAAZ,CAEA,CAAO,EAAON,IAAP,CAAY,EAAZ,CACV,CAEDO,SAAe,CACX,GAAI,EAAJ,CACI,KAAM,IAAIlD,UAAJ,CAAc,sBAAd,CAAN,CAGJ,KAAM,GAAW,CACT,KAAKmD,aAAL,EADS,CAET,KAAKC,gBAAL,GAFS,CAGT,KAAKC,iBAAL,EAHS,CAAjB,CAKI,EAAmB,GAAIC,MAAKC,YALhC,CAOA,MAAO7C,SAAQ8C,GAAR,IAAsBC,IAAtB,CACH,CAAC,OAAD,GAAwC,CACpC,KAAM,GAAoB,KAAKxC,IAAL,CAAUhF,KAAV,CAAgBgB,EAAhB,CACnB;4BACK,KAAKgE,IAAL,CAAUhF,KAAV,CAAgBgB,EAAG;6BAFL,CAIpB,EAJN,CAMA,MAAQ,qkDAAW;;;8BAGL,KAAKgE,IAAL,CAAUjF,MAAV,CAAiBmB,IAAK;;;;8BAItB,KAAKsE,WAAY;8BACjB,KAAKE,aAAL,CAAmB,CAAnB,CAAsB,IAAG,KAAKA,aAAL,CAAmB,CAAnB,CAAsB;;;8BAG/C,KAAKV,IAAL,CAAUnF,MAAO;;;8BAGjBe,QAAAA,CAAO,KAAKoE,IAAL,CAAUlF,IAAjBc,CAAuB,qBAAvBA,CAA8C;;;kCAG1C,KAAKoE,IAAL,CAAU3E,YAAa;;;iCAGxB,EAAiBO,MAAjB,CACD,KAAK2B,MAAL,CAAYS,WADX,CAEH;;;gCAGE,KAAKgC,IAAL,CAAUjF,MAAV,CAAiBiB,EAAG;;0BAzB7B,CA2BqB;wDA3BrB,CA4ByC;4DA5BzC,CA6BgD;6DA7BhD,CA8BkD;;2BAG5D,CAzCE,CA2CV,CAEDkG,eAAgB,CACZ,KAAM,GAAYO,SAASC,eAAT,CACV,4BADU,CAEV,KAFU,CAAlB,CAII,EAAgB,GAAIC,cAJxB,CAaA,MAPA,KAAqB,KAAKpB,qBAAL,EAArB,CAAmD,CAC/C3F,OAAQ,QADuC,CAE/CgH,eAF+C,CAG/CC,MAAO,GAHwC,CAI/CC,OAAQ,EAJuC,CAAnD,CAOA,CAAOrD,QAAQsD,OAAR,CAAgB,EAAcC,iBAAd,GAAhB,CACV,CAEDZ,mBAAoB,CAChB,MAAO,GAAa,KAAKZ,yBAAL,EAAb,CACV,CAEDW,mBAAyB,CACrB,GAAI,EAAJ,CACI,KAAM,IAAIpD,UAAJ,CAAc,sBAAd,CAAN,CAEJ,MAAO,GAAa,KAAK4C,wBAAL,GAAb,CACV,CAED,GAAIzB,SAAJ,EAAe,CACX,MAAO,MAAKD,KAAL,CAAWH,MAAX,CAAkB,KACd,EAAK7C,OAAL,GAAiB,EAAQ1C,GAD7B,CAGV,CAED,GAAI4F,aAAJ,EAAmB,CACf,MAAO,MAAKF,KAAL,CAAWH,MAAX,CAAkB,KACd,EAAK7C,OAAL,GAAiB,EAAQxC,QAD7B,CAGV,CAED,GAAI2F,aAAJ,EAAmB,CACf,MAAO,MAAKH,KAAL,CAAWH,MAAX,CAAkB,KACd,EAAK7C,OAAL,GAAiB,EAAQzC,QAD7B,CAGV,CAED,GAAIgG,YAAJ,EAAkB,CACd,MAAO,MAAKR,IAAL,CAAUlF,IAAV,CAAe2F,WAAf,GAA+B,IACzC,CAED,GAAIC,cAAJ,EAAoB,CAChB,GAAI,GAAQ,KAAKV,IAAL,CAAUlF,IAAV,CAAe6F,QAAf,GAA4B,CAAxC,CACA,MAAqB,EAAd,IAAQ,CAAR,CAAkB,CAAC,EAAQ,CAAT,GAAlB,CAAuC,GAAQ,EAAQ,CAAhB,CACjD,CAED,GAAIC,cAAJ,EAAoB,CAChB,MAAO,MAAKX,KAAL,CAAWtC,MAAX,CAAkB,OACd,EAAM,EAAKX,QADf,CAEJ,CAFI,CAGV,CAnRS,OAsRC,CACXiG,SADW,CAEXC,aAFW,CAGXC,MAHW,CAIX7F,QAJW,CAKXc,SALW,CAMXgF,YANW"}