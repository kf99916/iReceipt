{"version":3,"file":"ireceipt.js","sources":["../../src/js/tax-type.js","../../src/js/receipt-info.js","../../src/js/item.js","../../src/js/amount.js","../../src/js/common/utils.js","../../src/js/encode-type.js","../../src/js/aes.js","../../src/js/receipt.js"],"sourcesContent":["export default {\n    TAX: 1,\n    ZERO_TAX: 2,\n    FREE_TAX: 3,\n    SPECIAL_TAX: 4,\n    COMPOUND_TAX: 9\n};\n","import { format } from 'date-fns';\n\nclass ReceiptInfo {\n    constructor(\n        number,\n        date,\n        seller,\n        buyer,\n        type = '07',\n        carrier,\n        donationID,\n        orderno\n    ) {\n        this.number = number;\n        this.date = date;\n        this.seller = seller;\n        this.buyer = buyer;\n        this.type = type;\n        this.carrier = carrier;\n        this.donationID = donationID;\n        this.orderno = orderno;\n        this.randomNumber = Math.floor(1000 + Math.random() * 9000);\n    }\n\n    toXMLObject() {\n        let xmlObject = {\n            InvoiceNumber: this.number,\n            InvoiceDate: format(this.date, 'yyyyMMdd'),\n            InvoiceTime: format(this.date, 'hh:mm:ss'),\n            Seller: {\n                Identifier: this.seller.id,\n                Name: this.seller.name\n            },\n            Buyer: {\n                Identifier: this.buyer.id || '0000000000',\n                Name: this.buyer.name\n            },\n            InvoiceType: this.type,\n            DonateMark: 0,\n            PrintMark: this.carrier ? 'N' : 'Y',\n            RandomNumber: this.randomNumber\n        };\n\n        if (this.donationID) {\n            xmlObject.DonateMark = 1;\n            xmlObject.NPOBAN = this.donationID;\n        }\n\n        if (this.carrier) {\n            xmlObject.CarrierType = this.carrier.type;\n            xmlObject.CarrierId1 = this.carrier.id;\n            xmlObject.CarrierId2 = this.carrier.id;\n        }\n\n        return xmlObject;\n    }\n}\n\nexport default ReceiptInfo;\n","import TaxType from './tax-type';\n\nclass Item {\n    constructor(\n        description,\n        unitPrice,\n        sequenceNumber,\n        quantity = 1,\n        taxType = TaxType.TAX\n    ) {\n        this.description = description;\n        this.unitPrice = parseInt(unitPrice);\n        this.sequenceNumber = sequenceNumber;\n        this.quantity = parseInt(quantity);\n        this.taxType = taxType;\n    }\n\n    toXMLObject() {\n        return {\n            ProductItem: {\n                Description: this.description,\n                Quantity: this.quantity,\n                UnitPrice: this.unitPrice,\n                Amount: this.amount,\n                SequenceNumber: this.sequenceNumber\n            }\n        };\n    }\n\n    get amount() {\n        return this.unitPrice * this.quantity;\n    }\n}\n\nexport default Item;\n","import TaxType from './tax-type';\n\nclass Amount {\n    constructor(taxItems, freeTaxItems, zeroTaxItems) {\n        const taxRate = 0.05;\n        let amounts = taxItems.map(item => item.amount / (1 + taxRate));\n        this.salesAmount = Math.round(\n            amounts.reduce((amount, item) => amount + item, 0)\n        );\n        this.freeTaxSalesAmount = Math.round(\n            freeTaxItems.reduce((amount, item) => amount + item.amount, 0)\n        );\n        this.zeroTaxSalesAmount = Math.round(\n            zeroTaxItems.reduce((amount, item) => amount + item.amount, 0)\n        );\n\n        const hasTax = this.salesAmount !== 0,\n            hasFreeTax = this.freeTaxSalesAmount !== 0,\n            hasZeroTax = this.zeroTaxSalesAmount !== 0;\n\n        this.taxType = TaxType.SPECIAL_TAX;\n        if (\n            (hasTax && hasFreeTax) ||\n            (hasTax && hasZeroTax) ||\n            (hasFreeTax && hasZeroTax)\n        ) {\n            this.taxType = TaxType.COMPOUND_TAX;\n        } else if (hasTax) {\n            this.taxType = TaxType.TAX;\n        } else if (hasFreeTax) {\n            this.taxType = TaxType.FREE_TAX;\n        } else if (hasZeroTax) {\n            this.taxType = TaxType.ZERO_TAX;\n        }\n        this.taxRate =\n            this.taxType === TaxType.FREE_TAX ||\n            this.taxType === TaxType.ZERO_TAX\n                ? 0\n                : taxRate;\n        this.taxAmount = Math.round(this.salesAmount * this.taxRate);\n        this.totalAmount =\n            this.salesAmount +\n            this.freeTaxSalesAmount +\n            this.zeroTaxSalesAmount +\n            this.taxAmount;\n    }\n\n    toXMLObject() {\n        return {\n            SalesAmount: this.salesAmount,\n            FreeTaxSalesAmount: this.freeTaxSalesAmount,\n            ZeroTaxSalesAmount: this.zeroTaxSalesAmount,\n            TaxType: this.taxType,\n            TaxRate: this.taxRate,\n            TaxAmount: this.taxAmount,\n            TotalAmount: this.totalAmount\n        };\n    }\n}\n\nexport default Amount;\n","export default {\n    padZero: function(number, size) {\n        return ('000000000' + number).substr(-size);\n    },\n    repeat: function(string, times) {\n        let repeatedString = '';\n        while (times > 0) {\n            repeatedString += string;\n            times--;\n        }\n        return repeatedString;\n    }\n};\n","export default {\n    BIG5: 0,\n    UTF8: 1,\n    BASE64: 3\n};\n","import aesjs from 'aes-js';\n\nexport default {\n    encrypt: function(AESKey, plainText) {\n        if (!AESKey) {\n            throw new TypeError('AES Key is not found!');\n        }\n        const textBytes = aesjs.utils.utf8.toBytes(plainText),\n            aesCtr = new aesjs.ModeOfOperation.ctr(\n                AESKey,\n                new aesjs.Counter(5)\n            );\n\n        return aesCtr.encrypt(textBytes);\n    },\n    decrypt: function(AESKey, encryptedBytes) {\n        if (!AESKey) {\n            throw new TypeError('AES Key is not found');\n        }\n        const aesCtr = new aesjs.ModeOfOperation.ctr(\n                AESKey,\n                new aesjs.Counter(5)\n            ),\n            decryptedBytes = aesCtr.decrypt(encryptedBytes);\n\n        return aesjs.utils.utf8.fromBytes(decryptedBytes);\n    }\n};\n","import xml2js from 'xml2js';\nimport TaxType from './tax-type';\nimport ReceiptInfo from './receipt-info';\nimport Item from './item';\nimport Amount from './amount';\nimport utils from './common/utils';\nimport EncodeType from './encode-type';\nimport aes from './aes';\nimport JsBarcode from 'jsbarcode';\nimport QRCode from 'qrcode';\nimport { format } from 'date-fns';\nimport template from '../template/ireceipt.html';\n\nconst defaultInvoiceAttr = {\n        xmlns: 'urn:GEINV:eInvoiceMessage:C0401:3.1',\n        'xmlns:xsi': 'http://www.w3.org/2001/XMLSchema-instance',\n        'xsi:schemaLocation': 'urn:GEINV:eInvoiceMessage:C0401:3.1 C0401.xsd'\n    },\n    renderQRcode = function(text) {\n        return new Promise((resolve, reject) => {\n            const opts = {\n                errorCorrectionLevel: 'L',\n                version: 6\n            };\n            QRCode.toString(text, opts, (err, string) => {\n                if (err) {\n                    reject(error);\n                }\n                resolve(string);\n            });\n        });\n    };\n\nclass Receipt {\n    constructor(info, items) {\n        if (!(info instanceof ReceiptInfo)) {\n            throw new TypeError('Info is not ReceiptInfo class!');\n        }\n        const invalidItems = items.filter(item => !(item instanceof Item));\n        if (invalidItems.length > 0) {\n            throw new TypeError('Some items are not Item class!');\n        }\n\n        this.info = info;\n        this.items = items;\n        this.amount = new Amount(\n            this.taxItems,\n            this.freeTaxItems,\n            this.zeroTaxItems\n        );\n    }\n\n    // Static Methods\n    // The format of the list of winners:\n    // 53925591  10510LC60123189...\n    // 53925591  10510LC60122037...\n    // The range of receipt number is the 15th position and 10 characters\n    static parseWinnersList(winnersList) {\n        return winnersList\n            .split(/\\n|\\r\\n?/)\n            .map(winner => winner.substr(15, 10));\n    }\n\n    // Getters\n    get taxItems() {\n        return this.items.filter(item => item.taxType === TaxType.TAX);\n    }\n\n    get freeTaxItems() {\n        return this.items.filter(item => item.taxType === TaxType.FREE_TAX);\n    }\n\n    get zeroTaxItems() {\n        return this.items.filter(item => item.taxType === TaxType.ZERO_TAX);\n    }\n\n    get chineseYear() {\n        return this.info.date.getFullYear() - 1911;\n    }\n\n    get winningMonths() {\n        let month = this.info.date.getMonth() + 1;\n        return month % 2 === 0 ? [month - 1, month] : [month, month + 1];\n    }\n\n    get totalQuantity() {\n        return this.items.reduce((sum, item) => sum + item.quantity, 0);\n    }\n\n    // Methods\n    // Reference: https://www.einvoice.nat.gov.tw/home/DownLoad?fileName=1447235507091_0.zip\n    toXML() {\n        let receiptObject = {\n            $: defaultInvoiceAttr,\n            Main: this.info.toXMLObject(),\n            Details: [this.items.map(item => item.toXMLObject())],\n            Amounts: this.amount.toXMLObject()\n        };\n\n        const builder = new xml2js.Builder({\n            rootName: 'Invoice'\n        });\n        return builder.buildObject(receiptObject);\n    }\n\n    isWinning(winningNumbers) {\n        return winningNumbers.indexOf(this.info.number) !== -1;\n    }\n\n    // Reference: https://www.einvoice.nat.gov.tw/home/DownLoad?fileName=1479449792874_0.6(20161115).pdf\n    generateBarCodeString() {\n        return (\n            this.chineseYear +\n            utils.padZero(this.winningMonths[1], 2) +\n            this.info.number +\n            this.info.randomNumber\n        );\n    }\n\n    // Reference: https://www.einvoice.nat.gov.tw/home/DownLoad?fileName=1479449792874_0.6(20161115).pdf\n    generateRightQRCodeString() {\n        let qrcode = this.items.map((item, index) => {\n            let combineString = [];\n            combineString.push(index === 0 ? '**' : ':');\n            combineString.push(item.description.replace(':', '-'));\n            combineString.push(':' + item.quantity);\n            combineString.push(':' + item.unitPrice);\n            return combineString.join('');\n        });\n\n        return qrcode.join('');\n    }\n\n    generateLeftQRCodeString(\n        AESKey,\n        info = utils.repeat('*', 10),\n        encodeType = EncodeType.UTF8\n    ) {\n        if (!AESKey) {\n            throw new TypeError('AES Key is not found');\n        }\n\n        let qrcode = [],\n            dateString =\n                this.chineseYear +\n                utils.padZero(this.info.date.getMonth() + 1, 2) +\n                utils.padZero(this.info.date.getDate(), 2),\n            salesAmountHex16 = utils.padZero(\n                this.amount.salesAmount.toString(16).toUpperCase(),\n                8\n            ),\n            totalAmountHex16 = utils.padZero(\n                this.amount.totalAmount.toString(16).toUpperCase(),\n                8\n            ),\n            plainText = this.info.number + this.info.randomNumber,\n            padding = 16 - (plainText.length % 16);\n\n        plainText += utils.repeat(padding, padding);\n\n        const encryptText = Buffer.from(\n            aes.encrypt(AESKey, plainText)\n        ).toString('base64');\n\n        qrcode.push(this.info.number);\n        qrcode.push(dateString);\n        qrcode.push(this.info.randomNumber);\n        qrcode.push(salesAmountHex16);\n        qrcode.push(totalAmountHex16);\n        qrcode.push(this.info.buyer.id || utils.repeat('0', 8));\n        qrcode.push(this.info.seller.id);\n        qrcode.push(encryptText);\n        qrcode.push(':' + info);\n        qrcode.push(':' + this.items.length);\n        qrcode.push(':' + this.totalQuantity);\n        qrcode.push(':' + encodeType);\n\n        return qrcode.join('');\n    }\n\n    render(AESKey) {\n        if (!AESKey) {\n            throw new TypeError('AES Key is not found');\n        }\n\n        const promises = [\n                this.renderBarCode(),\n                this.renderLeftQRCode(AESKey),\n                this.renderRightQRCode()\n            ],\n            intlNumberFormat = new Intl.NumberFormat();\n\n        return Promise.all(promises).then(\n            ([barCode, leftQRCode, rightQRCode]) => {\n                const buyerIdHtmlString = this.info.buyer.id\n                    ? `<div class=\"buyer-identifier\">\n                        買方${this.info.buyer.id}\n                      </div>`\n                    : '';\n\n                return `${template}\n                    <div class=\"receipt\">\n                        <div class=\"einvoice-name\">\n                            ${this.info.seller.name}\n                        </div>\n                        <div class=\"receipt-title\">電子發票證明聯</div>\n                        <div class=\"receipt-year-month\">\n                            ${this.chineseYear}年\n                            ${this.winningMonths[0]}-${this.winningMonths[1]}月 \n                        </div>\n                        <div class=\"receipt-invoice-number\">\n                            ${this.info.number}\n                        </div>\n                        <div class=\"receipt-issue-time\">\n                            ${format(this.info.date, 'yyyy-MM-dd hh:mm:ss')}\n                        </div>\n                        <div class=\"receipt-random-number\">\n                            隨機碼 ${this.info.randomNumber}\n                        </div>\n                        <div class=\"receipt-amount\">\n                            總計 ${intlNumberFormat.format(\n                                this.amount.totalAmount\n                            )}\n                        </div>\n                        <div class=\"einvoice-identifier\">\n                            賣方${this.info.seller.id}\n                        </div>\n                        ${buyerIdHtmlString}\n                        <div class=\"einvoice-barcode\">${barCode}</div>\n                        <div class=\"einvoice-qrcode-left\">${leftQRCode}</div>\n                        <div class=\"einvoice-qrcode-right\">${rightQRCode}</div>\n                        <div class=\"einvoice-remark\">退貨憑電子發票證明聯正本辦理</div>\n                    </div>`;\n            }\n        );\n    }\n\n    renderBarCode() {\n        const svgObject = document.createElementNS(\n                'http://www.w3.org/2000/svg',\n                'svg'\n            ),\n            xmlSerializer = new XMLSerializer();\n\n        JsBarcode(svgObject, this.generateBarCodeString(), {\n            format: 'CODE39',\n            displayValue: false,\n            width: 0.6,\n            height: 25\n        });\n\n        return Promise.resolve(xmlSerializer.serializeToString(svgObject));\n    }\n\n    renderRightQRCode() {\n        return renderQRcode(this.generateRightQRCodeString());\n    }\n\n    renderLeftQRCode(AESKey) {\n        if (!AESKey) {\n            throw new TypeError('AES Key is not found');\n        }\n        return renderQRcode(this.generateLeftQRCodeString(AESKey));\n    }\n\n    get taxItems() {\n        return this.items.filter(item => item.taxType === TaxType.TAX);\n    }\n\n    get freeTaxItems() {\n        return this.items.filter(item => item.taxType === TaxType.FREE_TAX);\n    }\n\n    get zeroTaxItems() {\n        return this.items.filter(item => item.taxType === TaxType.ZERO_TAX);\n    }\n\n    get chineseYear() {\n        return this.info.date.getFullYear() - 1911;\n    }\n\n    get winningMonths() {\n        let month = this.info.date.getMonth() + 1;\n        return month % 2 === 0 ? [month - 1, month] : [month, month + 1];\n    }\n\n    get totalQuantity() {\n        return this.items.reduce((sum, item) => sum + item.quantity, 0);\n    }\n}\n\nexport default {\n    Receipt: Receipt,\n    ReceiptInfo: ReceiptInfo,\n    Item: Item,\n    Amount: Amount,\n    TaxType: TaxType,\n    EncodeType: EncodeType\n};\n"],"names":["TAX","ZERO_TAX","FREE_TAX","SPECIAL_TAX","COMPOUND_TAX","ReceiptInfo","number","date","seller","buyer","type","carrier","donationID","orderno","randomNumber","Math","floor","random","xmlObject","InvoiceNumber","InvoiceDate","format","InvoiceTime","Seller","Identifier","id","Name","name","Buyer","InvoiceType","DonateMark","PrintMark","RandomNumber","NPOBAN","CarrierType","CarrierId1","CarrierId2","Item","description","unitPrice","sequenceNumber","quantity","taxType","TaxType","parseInt","ProductItem","Description","Quantity","UnitPrice","Amount","amount","SequenceNumber","taxItems","freeTaxItems","zeroTaxItems","taxRate","amounts","map","item","salesAmount","round","reduce","freeTaxSalesAmount","zeroTaxSalesAmount","hasTax","hasFreeTax","hasZeroTax","taxAmount","totalAmount","SalesAmount","FreeTaxSalesAmount","ZeroTaxSalesAmount","TaxRate","TaxAmount","TotalAmount","padZero","size","substr","repeat","string","times","repeatedString","BIG5","UTF8","BASE64","encrypt","AESKey","plainText","TypeError","textBytes","aesjs","utils","utf8","toBytes","aesCtr","ModeOfOperation","ctr","Counter","decrypt","encryptedBytes","decryptedBytes","fromBytes","defaultInvoiceAttr","xmlns","renderQRcode","text","Promise","resolve","reject","opts","errorCorrectionLevel","version","QRCode","toString","err","error","Receipt","info","items","invalidItems","filter","length","receiptObject","$","Main","toXMLObject","Details","Amounts","builder","xml2js","Builder","rootName","buildObject","winningNumbers","indexOf","chineseYear","winningMonths","qrcode","index","combineString","push","replace","join","encodeType","EncodeType","dateString","getMonth","getDate","salesAmountHex16","toUpperCase","totalAmountHex16","padding","encryptText","Buffer","from","aes","totalQuantity","promises","renderBarCode","renderLeftQRCode","renderRightQRCode","intlNumberFormat","Intl","NumberFormat","all","then","barCode","leftQRCode","rightQRCode","buyerIdHtmlString","template","svgObject","document","createElementNS","xmlSerializer","XMLSerializer","JsBarcode","generateBarCodeString","displayValue","width","height","serializeToString","generateRightQRCodeString","generateLeftQRCodeString","getFullYear","month","sum","winnersList","split","winner"],"mappings":"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"}