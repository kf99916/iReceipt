(function(a,b){'object'==typeof exports&&'undefined'!=typeof module?module.exports=b(require('xml2js'),require('date-fns/esm'),require('aes-js'),require('jsbarcode'),require('qrcode')):'function'==typeof define&&define.amd?define(['xml2js','date-fns/esm','aes-js','jsbarcode','qrcode'],b):a.IReceipt=b(a.xml2js,a.esm,a.aesjs,a.JsBarcode,a.QRCode)})(this,function(a,b,c,d,e){'use strict';a=a&&a.hasOwnProperty('default')?a['default']:a,c=c&&c.hasOwnProperty('default')?c['default']:c,d=d&&d.hasOwnProperty('default')?d['default']:d,e=e&&e.hasOwnProperty('default')?e['default']:e;var f={TAX:1,ZERO_TAX:2,FREE_TAX:3,SPECIAL_TAX:4,COMPOUND_TAX:9};class g{constructor(a,b,c,d,e='07',f,g,h){this.number=a,this.date=b,this.seller=c,this.buyer=d,this.type=e,this.carrier=f,this.donationID=g,this.orderno=h,this.randomNumber=Math.floor(1e3+9e3*Math.random())}toXMLObject(){let a={InvoiceNumber:this.number,InvoiceDate:b.format(this.date,'YYYYMMDD'),InvoiceTime:b.format(this.date,'hh:mm:ss'),Seller:{Identifier:this.seller.id,Name:this.seller.name},Buyer:{Identifier:this.buyer.id||'0000000000',Name:this.buyer.name},InvoiceType:this.type,DonateMark:0,PrintMark:this.carrier?'N':'Y',RandomNumber:this.randomNumber};return this.donationID&&(a.DonateMark=1,a.NPOBAN=this.donationID),this.carrier&&(a.CarrierType=this.carrier.type,a.CarrierId1=this.carrier.id,a.CarrierId2=this.carrier.id),a}}class h{constructor(a,b,c,d=1,e=f.TAX){this.description=a,this.unitPrice=parseInt(b),this.sequenceNumber=c,this.quantity=parseInt(d),this.taxType=e}toXMLObject(){return{ProductItem:{Description:this.description,Quantity:this.quantity,UnitPrice:this.unitPrice,Amount:this.amount,SequenceNumber:this.sequenceNumber}}}get amount(){return this.unitPrice*this.quantity}}class i{constructor(a,b,c){var d=Math.round;const e=0.05;this.salesAmount=d(a.reduce((a,b)=>(a+b.amount)/(1+e),0)),this.freeTaxSalesAmount=d(b.reduce((a,b)=>a+b.amount,0)),this.zeroTaxSalesAmount=d(c.reduce((a,b)=>a+b.amount,0));const g=0!==this.salesAmount,h=0!==this.freeTaxSalesAmount,i=0!==this.zeroTaxSalesAmount;this.taxType=f.SPECIAL_TAX,g&&h||g&&i||h&&i?this.taxType=f.COMPOUND_TAX:g?this.taxType=f.TAX:h?this.taxType=f.FREE_TAX:i&&(this.taxType=f.ZERO_TAX),this.taxRate=this.taxType===f.FREE_TAX||this.taxType===f.ZERO_TAX?0:e,this.taxAmount=d(this.salesAmount*this.taxRate),this.totalAmount=this.salesAmount+this.freeTaxSalesAmount+this.zeroTaxSalesAmount+this.taxAmount}toXMLObject(){return{SalesAmount:this.salesAmount,FreeTaxSalesAmount:this.freeTaxSalesAmount,ZeroTaxSalesAmount:this.zeroTaxSalesAmount,TaxType:this.taxType,TaxRate:this.taxRate,TaxAmount:this.taxAmount,TotalAmount:this.totalAmount}}}var j={padZero:function(a,b){return('000000000'+a).substr(-b)},repeat:function(a,b){let c='';for(;0<b;)c+=a,b--;return c}},k={BIG5:0,UTF8:1,BASE64:3},l={encrypt:function(a,b){if(!a)throw new TypeError('AES Key is not found!');const d=c.utils.utf8.toBytes(b),e=new c.ModeOfOperation.ctr(a,new c.Counter(5));return e.encrypt(d)},decrypt:function(a,b){if(!a)throw new TypeError('AES Key is not found');const d=new c.ModeOfOperation.ctr(a,new c.Counter(5)),e=d.decrypt(b);return c.utils.utf8.fromBytes(e)}};const m={xmlns:'urn:GEINV:eInvoiceMessage:C0401:3.1',"xmlns:xsi":'http://www.w3.org/2001/XMLSchema-instance',"xsi:schemaLocation":'urn:GEINV:eInvoiceMessage:C0401:3.1 C0401.xsd'},n=function(a){return new Promise((b,c)=>{e.toString(a,{errorCorrectionLevel:'L',version:6},(a,d)=>{a&&c(error),b(d)})})};class o{constructor(a,b){if(!(a instanceof g))throw new TypeError('Info is not ReceiptInfo class!');const c=b.filter((a)=>!(a instanceof h));if(0<c.length)throw new TypeError('Some items are not Item class!');this.info=a,this.items=b,this.amount=new i(this.taxItems,this.freeTaxItems,this.zeroTaxItems)}// Static Methods
// The format of the list of winners:
// 53925591  10510LC60123189...
// 53925591  10510LC60122037...
// The range of receipt number is the 15th position and 10 characters
static parseWinnersList(a){return a.split(/\n|\r\n?/).map((a)=>a.substr(15,10))}// Getters
get taxItems(){return this.items.filter((a)=>a.taxType===f.TAX)}get freeTaxItems(){return this.items.filter((a)=>a.taxType===f.FREE_TAX)}get zeroTaxItems(){return this.items.filter((a)=>a.taxType===f.ZERO_TAX)}get chineseYear(){return this.info.date.getFullYear()-1911}get winningMonths(){let a=this.info.date.getMonth()+1;return 0==a%2?[a-1,a]:[a,a+1]}get totalQuantity(){return this.items.reduce((a,b)=>a+b.quantity,0)}// Methods
// Reference: https://www.einvoice.nat.gov.tw/home/DownLoad?fileName=1447235507091_0.zip
toXML(){let b={$:m,Main:this.info.toXMLObject(),Details:this.items.map((a)=>a.toXMLObject()),Amounts:this.amount.toXMLObject()};const c=new a.Builder({rootName:'Invoice'});return c.buildObject(b)}isWinning(a){return-1!==a.indexOf(this.info.number)}// Reference: https://www.einvoice.nat.gov.tw/home/DownLoad?fileName=1479449792874_0.6(20161115).pdf
generateBarCodeString(){return this.chineseYear+j.padZero(this.winningMonths[1],2)+this.info.number+this.info.randomNumber}// Reference: https://www.einvoice.nat.gov.tw/home/DownLoad?fileName=1479449792874_0.6(20161115).pdf
generateRightQRCodeString(){let a=this.items.map((a,b)=>{let c=[0===b?'**':':',a.description.replace(':','-'),':'+a.quantity,':'+a.unitPrice];return c.join('')});return a.join('')}generateLeftQRCodeString(a,b=j.repeat('*',10),c=k.UTF8){if(!a)throw new TypeError('AES Key is not found');let d=[],e=this.chineseYear+j.padZero(this.info.date.getMonth()+1,2)+j.padZero(this.info.date.getDate(),2),f=j.padZero(this.amount.salesAmount.toString(16).toUpperCase(),8),g=j.padZero(this.amount.totalAmount.toString(16).toUpperCase(),8),h=this.info.number+this.info.randomNumber,i=16-h.length%16;h+=j.repeat(i,i);const m=Buffer.from(l.encrypt(a,h)).toString('base64');return d.push(this.info.number),d.push(e),d.push(this.info.randomNumber),d.push(f),d.push(g),d.push(this.info.buyer.id||j.repeat('0',8)),d.push(this.info.seller.id),d.push(m),d.push(':'+b),d.push(':'+this.items.length),d.push(':'+this.totalQuantity),d.push(':'+c),d.join('')}render(a){if(!a)throw new TypeError('AES Key is not found');const c=[this.renderBarCode(),this.renderLeftQRCode(a),this.renderRightQRCode()],d=new Intl.NumberFormat;return Promise.all(c).then(([a,c,e])=>{const f=this.info.buyer.id?`<div class="buyer-identifier">
                        買方${this.info.buyer.id}
                      </div>`:'';return`${'<style type="text/css">\n    .receipt-year-month {\n        position: absolute;\n        top: 2.5cm;\n        left: 2.5cm;\n        font-size: 0.6cm;\n    }\n\n    .receipt-invoice-number {\n        position: absolute;\n        top: 3.2cm;\n        left: 2.8cm;\n        font-size: 0.6cm;\n    }\n\n    .receipt-issue-time {\n        position: absolute;\n        top: 3.9cm;\n        left: 1.8cm;\n    }\n\n    .receipt-random-number {\n        position: absolute;\n        top: 4.3cm;\n        left: 1.8cm;\n    }\n\n    .receipt-amount {\n        position: absolute;\n        top: 4.3cm;\n        left: 5.1cm;\n    }\n\n    .einvoice-name {\n        position: absolute;\n        top: 1.2cm;\n        left: 2.5cm;\n        font-size: 0.4cm;\n    }\n\n    .receipt-title {\n        position: absolute;\n        top: 1.8cm;\n        left: 2.5cm;\n        font-size: 0.6cm;\n    }\n\n    .einvoice-identifier {\n        position: absolute;\n        top: 4.7cm;\n        left: 1.8cm;\n    }\n\n    .buyer-identifier {\n        position: absolute;\n        top: 4.7cm;\n        left: 5cm;\n    }\n\n    .einvoice-barcode {\n        position: absolute;\n        top: 5.2cm;\n        left: 1.5cm;\n    }\n\n    .einvoice-qrcode-left,\n    .einvoice-qrcode-right {\n        width: 2.5cm;\n        position: absolute;\n        top: 6.2cm;\n    }\n\n    .einvoice-qrcode-left {\n        left: 1.6cm;\n    }\n\n    .einvoice-qrcode-right {\n        left: 4.9cm;\n    }\n\n    .einvoice-remark {\n        position: absolute;\n        top: 8.8cm;\n        left: 2.2cm;\n        font-size: 0.2cm;\n    }\n</style>'}
                    <div class="receipt">
                        <div class="einvoice-name">
                            ${this.info.seller.name}
                        </div>
                        <div class="receipt-title">電子發票證明聯</div>
                        <div class="receipt-year-month">
                            ${this.chineseYear}年
                            ${this.winningMonths[0]}-${this.winningMonths[1]}月 
                        </div>
                        <div class="receipt-invoice-number">
                            ${this.info.number}
                        </div>
                        <div class="receipt-issue-time">
                            ${b.format(this.info.date,'YYYY-MM-DD hh:mm:ss')}
                        </div>
                        <div class="receipt-random-number">
                            隨機碼 ${this.info.randomNumber}
                        </div>
                        <div class="receipt-amount">
                            總計 ${d.format(this.amount.totalAmount)}
                        </div>
                        <div class="einvoice-identifier">
                            賣方${this.info.seller.id}
                        </div>
                        ${f}
                        <div class="einvoice-barcode">${a}</div>
                        <div class="einvoice-qrcode-left">${c}</div>
                        <div class="einvoice-qrcode-right">${e}</div>
                        <div class="einvoice-remark">退貨憑電子發票證明聯正本辦理</div>
                    </div>`})}renderBarCode(){const a=document.createElementNS('http://www.w3.org/2000/svg','svg'),b=new XMLSerializer;return d(a,this.generateBarCodeString(),{format:'CODE39',displayValue:!1,width:0.6,height:25}),Promise.resolve(b.serializeToString(a))}renderRightQRCode(){return n(this.generateRightQRCodeString())}renderLeftQRCode(a){if(!a)throw new TypeError('AES Key is not found');return n(this.generateLeftQRCodeString(a))}get taxItems(){return this.items.filter((a)=>a.taxType===f.TAX)}get freeTaxItems(){return this.items.filter((a)=>a.taxType===f.FREE_TAX)}get zeroTaxItems(){return this.items.filter((a)=>a.taxType===f.ZERO_TAX)}get chineseYear(){return this.info.date.getFullYear()-1911}get winningMonths(){let a=this.info.date.getMonth()+1;return 0==a%2?[a-1,a]:[a,a+1]}get totalQuantity(){return this.items.reduce((a,b)=>a+b.quantity,0)}}return{Receipt:o,ReceiptInfo:g,Item:h,Amount:i,TaxType:f,EncodeType:k}});
//# sourceMappingURL=ireceipt.min.js.map
