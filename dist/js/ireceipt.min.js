(function(a,b){'object'==typeof exports&&'undefined'!=typeof module?module.exports=b(require('xml2js'),require('date-fns/esm'),require('aes-js')):'function'==typeof define&&define.amd?define(['xml2js','date-fns/esm','aes-js'],b):a.ireceipt=b(a.xml2js,a.esm,a.aesjs)})(this,function(a,b,c){'use strict';a=a&&a.hasOwnProperty('default')?a['default']:a,c=c&&c.hasOwnProperty('default')?c['default']:c;var d={TAX:1,ZERO_TAX:2,FREE_TAX:3,SPECIAL_TAX:4,COMPOUND_TAX:9};class e{constructor(a,b,c,d,e='07',f,g,h){this.number=a,this.date=b,this.seller=c,this.buyer=d,this.type=e,this.carrier=f,this.donationID=g,this.orderno=h,this.randomNumber=Math.floor(1e3+9e3*Math.random())}toXMLObject(){let a={InvoiceNumber:this.number,InvoiceDate:b.format(this.date,'YYYYMMDD'),InvoiceTime:b.format(this.date,'hh:mm:ss'),Seller:{Identifier:this.seller.id,Name:this.seller.name},Buyer:{Identifier:this.buyer.id||'0000000000',Name:this.buyer.name},InvoiceType:this.type,DonateMark:0,PrintMark:this.carrier?'N':'Y',RandomNumber:this.randomNumber};return this.donationID&&(a.DonateMark=1,a.NPOBAN=this.donationID),this.carrier&&(a.CarrierType=this.carrier.type,a.CarrierId1=this.carrier.id,a.CarrierId2=this.carrier.id),a}}class f{constructor(a,b,c,e=1,f=d.TAX){this.description=a,this.unitPrice=parseInt(b),this.sequenceNumber=c,this.quantity=parseInt(e),this.taxType=f}toXMLObject(){return{ProductItem:{Description:this.description,Quantity:this.quantity,UnitPrice:this.unitPrice,Amount:this.amount,SequenceNumber:this.sequenceNumber}}}get amount(){return this.unitPrice*this.quantity}}class g{constructor(a,b,c){var e=Math.round;const f=0.05;this.salesAmount=e(a.reduce((a,b)=>(a+b.amount)/(1+f),0)),this.freeTaxSalesAmount=e(b.reduce((a,b)=>a+b.amount,0)),this.zeroTaxSalesAmount=e(c.reduce((a,b)=>a+b.amount,0));const g=0!==this.salesAmount,h=0!==this.freeTaxSalesAmount,i=0!==this.zeroTaxSalesAmount;this.taxType=d.SPECIAL_TAX,g&&h||g&&i||h&&i?this.taxType=d.COMPOUND_TAX:g?this.taxType=d.TAX:h?this.taxType=d.FREE_TAX:i&&(this.taxType=d.ZERO_TAX),this.taxRate=this.taxType===d.FREE_TAX||this.taxType===d.ZERO_TAX?0:f,this.taxAmount=e(this.salesAmount*this.taxRate),this.totalAmount=this.salesAmount+this.freeTaxSalesAmount+this.zeroTaxSalesAmount+this.taxAmount}toXMLObject(){return{SalesAmount:this.salesAmount,FreeTaxSalesAmount:this.freeTaxSalesAmount,ZeroTaxSalesAmount:this.zeroTaxSalesAmount,TaxType:this.taxType,TaxRate:this.taxRate,TaxAmount:this.taxAmount,TotalAmount:this.totalAmount}}}var h={padZero:function(a,b){return('000000000'+a).substr(-b)},repeat:function(a,b){let c='';for(;0<b;)c+=a,b--;return c}},i={BIG5:0,UTF8:1,BASE64:3},j={encrypt:function(a,b){if(!a)throw new TypeError('AES Key is not found!');const d=c.utils.utf8.toBytes(b),e=new c.ModeOfOperation.ctr(a,new c.Counter(5));return e.encrypt(d)},decrypt:function(a,b){if(!a)throw new TypeError('AES Key is not found');const d=new c.ModeOfOperation.ctr(a,new c.Counter(5)),e=d.decrypt(b);return c.utils.utf8.fromBytes(e)}};const k={xmlns:'urn:GEINV:eInvoiceMessage:C0401:3.1',"xmlns:xsi":'http://www.w3.org/2001/XMLSchema-instance',"xsi:schemaLocation":'urn:GEINV:eInvoiceMessage:C0401:3.1 C0401.xsd'};class l{constructor(a,b){if(!(a instanceof e))throw new TypeError('Info is not ReceiptInfo class!');const c=b.filter((a)=>!(a instanceof f));if(0<c.length)throw new TypeError('Some items are not Item class!');this.info=a,this.items=b,this.amount=new g(this.taxItems,this.freeTaxItems,this.zeroTaxItems)}// Static Methods
// The format of the list of winners:
// 53925591  10510LC60123189...
// 53925591  10510LC60122037...
// The range of receipt number is the 15th position and 10 characters
static parseWinnersList(a){return a.split(/\n|\r\n?/).map((a)=>a.substr(15,10))}// Getters
get taxItems(){return this.items.filter((a)=>a.taxType===d.TAX)}get freeTaxItems(){return this.items.filter((a)=>a.taxType===d.FREE_TAX)}get zeroTaxItems(){return this.items.filter((a)=>a.taxType===d.ZERO_TAX)}get chineseYear(){return this.info.date.getFullYear()-1911}get winningMonths(){let a=this.info.date.getMonth()+1;return 0==a%2?[a-1,a]:[a,a+1]}get totalQuantity(){return this.items.reduce((a,b)=>a+b.quantity,0)}// Methods
// Reference: https://www.einvoice.nat.gov.tw/home/DownLoad?fileName=1447235507091_0.zip
toXML(){let b={$:k,Main:this.info.toXMLObject(),Details:this.items.map((a)=>a.toXMLObject()),Amounts:this.amount.toXMLObject()};const c=new a.Builder({rootName:'Invoice'});return c.buildObject(b)}isWinning(a){return-1!==a.indexOf(this.info.number)}// Reference: https://www.einvoice.nat.gov.tw/home/DownLoad?fileName=1479449792874_0.6(20161115).pdf
generateBarCodeString(){return this.chineseYear+h.padZero(this.winningMonths[1],2)+this.info.number+this.info.randomNumber}// Reference: https://www.einvoice.nat.gov.tw/home/DownLoad?fileName=1479449792874_0.6(20161115).pdf
generateRightQRCodeString(){let a=this.items.map((a,b)=>{let c=[0===b?'**':':',a.description.replace(':','-'),':'+a.quantity,':'+a.unitPrice];return c.join('')});return a.join('')}generateLeftQRCodeString(a,b=h.repeat('*',10),c=i.UTF8){if(!a)throw new TypeError('AES Key is not found');let d=[],e=this.chineseYear+h.padZero(this.info.date.getMonth()+1,2)+h.padZero(this.info.date.getDate(),2),f=h.padZero(this.amount.salesAmount.toString(16).toUpperCase(),8),g=h.padZero(this.amount.totalAmount.toString(16).toUpperCase(),8),k=this.info.number+this.info.randomNumber,l=16-k.length%16;k+=h.repeat(l,l);const m=Buffer.from(j.encrypt(a,k)).toString('base64');return d.push(this.info.number),d.push(e),d.push(this.info.randomNumber),d.push(f),d.push(g),d.push(this.info.buyer.id||h.repeat('0',8)),d.push(this.info.seller.id),d.push(m),d.push(':'+b),d.push(':'+this.items.length),d.push(':'+this.totalQuantity),d.push(':'+c),d.join('')}}return{Receipt:l,ReceiptInfo:e,Item:f,Amount:g,TaxType:d,EncodeType:i}});
//# sourceMappingURL=ireceipt.min.js.map
